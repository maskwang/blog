---
title: ' 十个超级有用的PHP代码片段'
id: 469
categories:
  - Php
  - 技术专栏
  - 编程语言
date: 2012-02-01 11:38:27
tags:
---

&nbsp;
<pre>1\. 发送短信
调用 TextMagic API。

// Include the TextMagic PHP lib
require('textmagic-sms-api-php/TextMagicAPI.php');

// Set the username and password information
$username = 'myusername';
$password = 'mypassword';

// Create a new instance of TM
$router = new TextMagicAPI(array(
'username' =&gt; $username,
'password' =&gt; $password
));

// Send a text message to '999-123-4567'
$result = $router-&gt;send('Wake up!', array(9991234567), true);

// result: Result is: Array ( [messages] =&gt; Array ( [19896128] =&gt; 9991234567 ) [sent_text] =&gt; Wake up! [parts_count] =&gt; 1 )

2\. 根据IP查找地址

function detect_city($ip) {

$default = 'UNKNOWN';

if (!is_string($ip) || strlen($ip) &lt; 1 || $ip == '127.0.0.1' || $ip == 'localhost')
$ip = '8.8.8.8';

$curlopt_useragent = 'Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.9.2) Gecko/20100115 Firefox/3.6 (.NET CLR 3.5.30729)';

$url = 'http://ipinfodb.com/ip_locator.php?ip=' . urlencode($ip);
$ch = curl_init();

$curl_opt = array(
CURLOPT_FOLLOWLOCATION =&gt; 1,
CURLOPT_HEADER =&gt; 0,
CURLOPT_RETURNTRANSFER =&gt; 1,
CURLOPT_USERAGENT =&gt; $curlopt_useragent,
CURLOPT_URL =&gt; $url,
CURLOPT_TIMEOUT =&gt; 1,
CURLOPT_REFERER =&gt; 'http://' . $_SERVER['HTTP_HOST'],
);

curl_setopt_array($ch, $curl_opt);

$content = curl_exec($ch);

if (!is_null($curl_info)) {
$curl_info = curl_getinfo($ch);
}

curl_close($ch);

if ( preg_match('{&lt;li&gt;City : ([^&lt;]*)&lt;/li&gt;}i', $content, $regs) ) {
$city = $regs[1];
}
if ( preg_match('{&lt;li&gt;State/Province : ([^&lt;]*)&lt;/li&gt;}i', $content, $regs) ) {
$state = $regs[1];
}

if( $city!='' &amp;&amp; $state!='' ){
$location = $city . ', ' . $state;
return$location;
}else{
return$default;
}

}

3\. 显示网页的源代码

&lt;?php // display source code
$lines = file('http://google.com/');
foreach ($lines as $line_num =&gt; $line) {
// loop thru each line and prepend line numbers
echo "Line #&lt;b&gt;{$line_num}&lt;/b&gt; : " . htmlspecialchars($line) . "&lt;br&gt;\n";
}

4\. 检查服务器是否使用HTTPS

if ($_SERVER['HTTPS'] != "on") {
echo "This is not HTTPS";
}else{
echo "This is HTTPS";
}

5\. 显示Faceboo**丝数量

function fb_fan_count($facebook_name){
// Example: https://graph.facebook.com/digimantra
$data = json_decode(file_get_contents("https://graph.facebook.com/".$facebook_name));
echo $data-&gt;likes;
}

6\. 检测图片的主要颜色

$i = imagecreatefromjpeg("image.jpg");

for ($x=0;$x&lt;imagesx($i);$x++) {
for ($y=0;$y&lt;imagesy($i);$y++) {
$rgb = imagecolorat($i,$x,$y);
$r = ($rgb &gt;&gt; 16) &amp; 0xFF;
$g = ($rgb &gt;&gt; &amp; 0xFF;
$b = $rgb &amp; 0xFF;

$rTotal += $r;
$gTotal += $g;
$bTotal += $b;
$total++;
}
}

$rAverage = round($rTotal/$total);
$gAverage = round($gTotal/$total);
$bAverage = round($bTotal/$total);

7\. 获取内存使用信息

echo"Initial: ".memory_get_usage()." bytes \n";
/* prints
Initial: 361400 bytes
*/
// http://www.baoluowanxiang.com/
// let's use up some memory
for ($i = 0; $i &lt; 100000; $i++) {
$array []= md5($i);
}

// let's remove half of the array
for ($i = 0; $i &lt; 100000; $i++) {
unset($array[$i]);
}

echo"Final: ".memory_get_usage()." bytes \n";
/* prints
Final: 885912 bytes
*/

echo"Peak: ".memory_get_peak_usage()." bytes \n";
/* prints
Peak: 13687072 bytes
*/

8\. 使用 gzcompress() 压缩数据

$string =
"Lorem ipsum dolor sit amet, consectetur
adipiscing elit. Nunc ut elit id mi ultricies
adipiscing. Nulla facilisi. Praesent pulvinar,
sapien vel feugiat vestibulum, nulla dui pretium orci,
non ultricies elit lacus quis ante. Lorem ipsum dolor
sit amet, consectetur adipiscing elit. Aliquam
pretium ullamcorper urna quis iaculis. Etiam ac massa
sed turpis tempor luctus. Curabitur sed nibh eu elit
mollis congue. Praesent ipsum diam, consectetur vitae
ornare a, aliquam a nunc. In id magna pellentesque
tellus posuere adipiscing. Sed non mi metus, at lacinia
augue. Sed magna nisi, ornare in mollis in, mollis
sed nunc. Etiam at justo in leo congue mollis.
Nullam in neque eget metus hendrerit scelerisque
eu non enim. Ut malesuada lacus eu nulla bibendum
id euismod urna sodales. ";

$compressed = gzcompress($string);

echo "Original size: ". strlen($string)."\n";
/* prints
Original size: 800
*/

echo "Compressed size: ". strlen($compressed)."\n";
/* prints
Compressed size: 418
*/

// getting it back
$original = gzuncompress($compressed);

9\. 使用PHP做Whois检查

function whois_query($domain) {

// fix the domain name:
$domain = strtolower(trim($domain));
$domain = preg_replace('/^http:\/\//i', '', $domain);
$domain = preg_replace('/^www\./i', '', $domain);
$domain = explode('/', $domain);
$domain = trim($domain[0]);

// split the TLD from domain name
$_domain = explode('.', $domain);
$lst = count($_domain)-1;
$ext = $_domain[$lst];

// You find resources and lists
// like these on wikipedia:
//
// http://de.wikipedia.org/wiki/Whois
//
$servers = array(
"biz" =&gt; "whois.neulevel.biz",
"com" =&gt; "whois.internic.net",
"us" =&gt; "whois.nic.us",
"coop" =&gt; "whois.nic.coop",
"info" =&gt; "whois.nic.info",
"name" =&gt; "whois.nic.name",
"net" =&gt; "whois.internic.net",
"gov" =&gt; "whois.nic.gov",
"edu" =&gt; "whois.internic.net",
"mil" =&gt; "rs.internic.net",
"int" =&gt; "whois.iana.org",
"ac" =&gt; "whois.nic.ac",
"ae" =&gt; "whois.uaenic.ae",
"at" =&gt; "whois.ripe.net",
"au" =&gt; "whois.aunic.net",
"be" =&gt; "whois.dns.be",
"bg" =&gt; "whois.ripe.net",
"br" =&gt; "whois.registro.br",
"bz" =&gt; "whois.belizenic.bz",
"ca" =&gt; "whois.cira.ca",
"cc" =&gt; "whois.nic.cc",
"ch" =&gt; "whois.nic.ch",
"cl" =&gt; "whois.nic.cl",
"cn" =&gt; "whois.cnnic.net.cn",
"cz" =&gt; "whois.nic.cz",
"de" =&gt; "whois.nic.de",
"fr" =&gt; "whois.nic.fr",
"hu" =&gt; "whois.nic.hu",
"ie" =&gt; "whois.domainregistry.ie",
"il" =&gt; "whois.isoc.org.il",
"in" =&gt; "whois.ncst.ernet.in",
"ir" =&gt; "whois.nic.ir",
"mc" =&gt; "whois.ripe.net",
"to" =&gt; "whois.tonic.to",
"tv" =&gt; "whois.tv",
"ru" =&gt; "whois.ripn.net",
"org" =&gt; "whois.pir.org",
"aero" =&gt; "whois.information.aero",
"nl" =&gt; "whois.domain-registry.nl"
);

if (!isset($servers[$ext])){
die('Error: No matching nic server found!');
}

$nic_server = $servers[$ext];

$output = '';

// connect to whois server:
if ($conn = fsockopen ($nic_server, 43)) {
fputs($conn, $domain."\r\n");
while(!feof($conn)) {
$output .= fgets($conn,128);
}
fclose($conn);
}
else { die('Error: Could not connect to ' . $nic_server . '!'); }

return $output;
}

10\. 通过Email发送PHP错误

&lt;?php

// Our custom error handler
function nettuts_error_handler($number, $message, $file, $line, $vars){
$email = "
&lt;p&gt;An error ($number) occurred on line
&lt;strong&gt;$line&lt;/strong&gt; and in the &lt;strong&gt;file: $file.&lt;/strong&gt;
&lt;p&gt; $message &lt;/p&gt;";

$email .= "&lt;pre&gt;" . print_r($vars, 1) . "&lt;/pre&gt;";

$headers = 'Content-type: text/html; charset=iso-8859-1' . "\r\n";

// Email the error to someone...
error_log($email, 1, 'you@youremail.com', $headers);

// Make sure that you decide how to respond to errors (on the user's side)
// Either echo an error message, or kill the entire project. Up to you...
// The code below ensures that we only "die" if the error was more than
// just a NOTICE.
if ( ($number !== E_NOTICE) &amp;&amp; ($number &lt; 2048) ) {
die("There was an error. Please try again later.");
}
}

// We should use our custom function to handle errors.
set_error_handler('nettuts_error_handler');

// Trigger an error... (var doesn't exist)
echo$somevarthatdoesnotexist;

</pre>
<span style="font-size: small;"><span style="line-height: normal;">
</span></span>