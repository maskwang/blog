---
title: ORM学习
id: 98
categories:
  - Mysql
  - 技术专栏
date: 2011-08-22 22:42:27
tags:
---

对象关系映射（Object Relational Mapping，简称ORM）是一种为了解决面向对象与关系数据库存在的互不匹配的现象的技术。 简单的说，ORM是通过使用描述对象和数据库之间映射的元数据，将java程序中的对象自动持久化到关系数据库中。本质上就是将数据从一种形式转换到另外 一种形式。 这也同时暗示者额外的执行开销；然而，如果ORM作为一种中间件实现，则会有很多机会做优化，而这些在手写的持久层并不存在。 更重要的是用于控制转换的元数据需要提供和管理；但是同样，这些花费要比维护手写的方案要少；而且就算是遵守ODMG规范的对象数据库依然需要类级别的元 数据。
<div></div>
对象-关系映射（Object/Relation Mapping，简称ORM），是随着面向对象的软件开发方法发展而产生的。面向对象的开发方法是当今企业级应用开发环境中的主流开发方法，关系数据库是 企业级应用环境中永久存放数据的主流数据存储系统。对象和关系数据是业务实体的两种表现形式，业务实体在内存中表现为对象，在数据库中表现为关系数据。内 存中的对象之间存在关联和继承关系，而在数据库中，关系数据无法直接表达多对多关联和继承关系。因此，对象-关系映射(ORM)系统一般以中间件的形式存 在，主要实现程序对象到关系数据库数据的映射。
<div></div>
面向对象是从软件工程基本原则(如耦合、聚合、封装)的基础上发展起来的，而关系数据库则是从数学理论发展而来的，两套理论存在显著的区别。为了解决 这个不匹配的现象,对象关系映射技术应运而生。
<div></div>
让我们从O/R开始。字母O起源于"对象"(Object),而R则来自于"关系"(Relational)。几乎所有的程序里面，都存在对象和关系 数据库。在业务逻辑层和用户界面层中，我们是面向对象的。当对象信息发生变化的时候，我们需要把对象的信息保存在关系数据库中。
<div></div>
当你开发一个应用程序的时候(不使用O/R Mapping),你可能会写不少数据访问层的代码，用来从数据库保存，删除，读取对象信息，等等。你在DAL中写了很多的方法来读取对象数据，改变状态 对象等等任务。而这些代码写起来总是重复的。
<div></div>
如果打开你最近的程序，看看DAL代码，你肯定会看到很多近似的通用的模式。我们以保存对象的方法为例，你传入一个对象，为SqlCommand对象 添加SqlParameter，把所有属性和对象对应，设置SqlCommand的CommandText属性为存储过程，然后运行 SqlCommand。对于每个对象都要重复的写这些代码。
<div></div>
除此之外，还有更好的办法吗？有，引入一个O/R Mapping。实质上，一个O/R Mapping会为你生成DAL。与其自己写DAL代码，不如用O/R Mapping。你用O/R Mapping保存，删除，读取对象，O/R Mapping负责生成SQL，你只需要关心对象就好。
<div></div>
对象关系映射成功运用在不同的面向对象持久层产品中，如:Torque,OJB,Hibernate,TopLink,Castor JDO, TJDO 等。
<div></div>
一般的ORM包括以下四部分：
<div></div>
一个对持久类对象进行CRUD操作的API；
<div></div>
一个语言或API用来规定与类和类属性相关的查询；
<div></div>
一个规定mapping metadata的工具；
<div></div>
一种技术可以让ORM的实现同事务对象一起进行dirty checking, lazy association fetching以及其他的优化操作。
<div></div>
一、目前流行的 ORM 产品
<div></div>
目前众多厂商和开源社区都提供了持久层框架的实现，常见的有：
<div></div>
Apache OJB （http://db.apache.org/ojb/）
<div></div>
Cayenne （http://objectstyle.org/cayenne/）
<div></div>
Jaxor （http://jaxor.sourceforge.net）
<div></div>
Hibernate （http://www.hibernate.org）
<div></div>
iBatis （http://www.ibatis.com）
<div></div>
jRelationalFramework （http://ijf.sourceforge.net）
<div></div>
mirage （http://itor.cq2.org/en/oss/mirage/toon）
<div></div>
SMYLE （http://www.drjava.de/smyle）
<div></div>
TopLink （http://otn.oracle.com/products/ias/toplink/index.html）
<div></div>
其中 TopLink 是 Oracle 的商业产品，其他均为开源项目。
<div></div>
其中 Hibernate 的轻量级 ORM 模型逐步确立了在 Java ORM 架构中领导地位，甚至取代复杂而又繁琐的 EJB 模型而成为事实上的 Java ORM 工业标准。而且其中的许多设计均被 J2EE 标准组织吸纳而成为最新 EJB 3.0 规范的标准，这也是开源项目影响工业领域标准的有力见证。
<div></div>
二、对象－关系映射模式
<div></div>
从《公共仓库元模型：开发指南》一书第8章CWM元仓库中摘录出来的内容，实现了公共仓库元模型(CWM)的UML图到Microsoft SQL Server数据库的映射，是一种将对象层次结构映射成关系型结构的方法。个人认为可以作为将本体(Ontology)文件存储到关系型数据库中的一种可 借鉴方法。
<div></div>
基本情况：公共仓库元模型(CWM)是对象管理组织(OMG)的一种和数据仓库相关的元模型标准，采用UML表示的对象层次结构，在保存到数据库中时 由于面向对象的数据库技术的不完善(理论研究和商业应用都不是主流)，所以该书的作者倾向于使用成熟的关系型数据库来保存－这也是存储本体时所遇到的问 题。
<div></div>
采用方法：将UML模型中的各种元素通过转换，保存为数据库模式。由于CWM是一种元模型，因此模型的实例也是一种模型，将这种实例以数据库数据的形 式保存。使用数据库中比较成熟的存储过程技术提高开发和执行效率。
<div></div>
1、数据类型映射模式
<div></div>
1.1简单数据类型模式：建立UML和关系型数据库中简单数据类型的映射表以指导映射。
<div></div>
1.2枚举数据类型模式：每种枚举类型对应一个表，只有一个列(_EnumLiteral)表示枚举值。
<div></div>
1.3基于类的数据类型模式：使用外键约束，将基础列与基于类的类型实例相关联。
<div></div>
2、类映射模型
<div></div>
每个类对应一个表。单值属性、多值属性、继承关系可以用下述方法映射，而引用属性将在关联映射模式中提到。
<div></div>
2.1单值属性模式：是cardinality的上界为1的属性，映射到类所对应的表的列上。若其下界也为1（必须有的属性），列属性为NOT NULL。
<div></div>
2.2多值属性模式：每个多值属性映射成一个独立的表，使用外键连接到类所对应的表上。
<div></div>
2.3继承模式：每加入一个类的实例时，根据其继承关系自顶向下生成每个类的对象，这些对象具有相同的ID（根对象对应记录的主键）。删除对象实例 时，自底向上删除数据。遇到从中间删的情况怎么办？多重继承怎么处理？（金龙飞）
<div></div>
3、关联映射模式
<div></div>
3.1一对一关联模式：在关联两端各加一列。
<div></div>
3.2一对多关联模式：和3.1一样。如果多这端是有序的，还需加入一列表示序号。
<div></div>
3.3多对多关联模式：将关联单独作一个表。
<div></div>
3.4组合关联模式：注意级联式删除。
<div></div>
3.5反演关联模式：关联两端指向相关的类型，和普通关联一样。
<div></div>
3.6成对关联模式：关联记录两个类间的关系，用交集类表示关联，表示成一个单独的表，每个关联对应一个表，用外键表示它们间的关系。
<div></div>
3.7关联上的OCL需要分析成对应的存储过程代码。
<div></div>
3.8保证关联的cardinality也需要分析成对应的存储过程代码。
<div></div>
4、引用映射模式
<div></div>
在UML中不存在的MOF特征，指属性是声明为引用类型的实例。用存储过程实现